<!DOCTYPE html>
<html>
<head>
	<title>OSM Tchoutchou - Raildar with Leaflet and Open Street Map</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
	<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
	<link rel="stylesheet" href="./static/bootstrap3/css/bootstrap.min.css">
	<link rel="stylesheet" href="./static/jquery.jqplot.css">
	<link rel="stylesheet" href="./static/leaflet.css" />
	<!-- date time picker-->
	<link rel="stylesheet" href="./static/jquery-ui-1.10.3.custom.css" />
	<link rel="stylesheet" href="./static/jquery-ui-timepicker-addon.css" />
        <!-- fin date time picker-->
	<link rel="shortcut icon" href="./static/train.ico" />
	
	<style>
		body {
			padding: 0;
			margin: 0;
			font-family: Verdana, "DejaVu Sans", "Bitstream Vera Sans", Geneva, sans-serif;
			font-size:10pt;
		}
		a{
			color:#666;
			font-weight:bold;
		}
		html, body, #map {
			height: 100%;
		}
		
		#title{
			font-size:1.8em;
			padding-top:0!important;
			border-bottom:solid 1px #888;
			overflow:auto;
		}
		#title img{
			height:1.8em;
		}
		#icon{
			display:inline-block;
			width:43px;
			height:43px;
			position:relative;
			top:0.5em;
		}
		
		#icon #icon-loading{
			display:none;
		}
		
		#icon.loading{
			-webkit-animation: fade 0.6s linear infinite;
			-moz-animation: fade 0.6s linear infinite;
			-ms-animation: fade 0.6s linear infinite;
			-o-animation: fade 0.6s linear infinite;
			animation: fade 0.6s linear infinite;
		}
		
		#icon.loading #icon-loading{
			display:inline;
		}
		
		#icon.loading #icon-fixed{
			display:none;
		}	
		
		
		
		#icon.loading{
 			-webkit-animation: fade 0.6s linear infinite;
			-moz-animation: fade 0.6s linear infinite;
			-ms-animation: fade 0.6s linear infinite;
			-o-animation: fade 0.6s linear infinite;
			animation: fade 0.6s linear infinite; 
		}

		/* animation */
		@-webkit-keyframes fade {
			0% { opacity:0.5 }
			60% { opacity:0.9 }
			100% { opacity:0.5 }
		}
		
		@-moz-keyframes fade {
			0% { opacity:0.5 }
			60% { opacity:0.9 }
			100% { opacity:0.5 }
		}
		
		@-ms-keyframes fade {
			0% { opacity:0.5 }
			60% { opacity:0.9 }
			100% { opacity:0.5 }
		}
		
		@-o-keyframes fade {
			0% { opacity:0.5 }
			60% { opacity:0.9 }
			100% { opacity:0.5 }
		}
		
		@keyframes fade {
			0% { opacity:0.5 }
			60% { opacity:0.9 }
			100% { opacity:0.5 }
		} 
		
		.right {text-align:right}

		.animated .circle-icon, .animated .leaflet-popup{
			-webkit-transition: all 20s linear;
			-moz-transition: all 20s linear;
			-o-transition: all 20s linear;
			transition: all 20s linear;
		}
		.circle-icon{
			border-radius:9px;
			opacity:0.9;
			/* box-shadow: 0px 0px 2px #444; */
			text-align:center;
			line-height:18px;
			overflow:hidden;
			font-size:12px;
			color:#FFF;
		}
		
		.circle-icon img{
			width:22px;
			height:22px;
		}
		
		
		#sidebar>div{
			padding:1em;
		}
		#sidebar{
			width:380px;
			position:absolute;
			background-color:rgba(255,255,255,0.8);
			top:0px;
			right:0px;
			height:100%;
			-webkit-transition: width 0.3s;
			-moz-transition: width 0.3s;
			-o-transition: width 0.3s;
			transition: width 0.3s;
			max-width:100%;
			display:none;
			z-index:900;
			overflow:auto;
		}
		.leaflet-bottom{
			z-index:800!important;
		}
		.leaflet-control-attribution{
			opacity:0.5;
		}
		
		.button{
			position:absolute;
			right:10px;
			width:36px;
			text-align:center;
			overflow:hidden;
			height:36px;
			padding:0;
			
			cursor:pointer;
			border-radius:6px 0 0 6px;
			font-size:1.5em;
			line-height:36px;
			
			box-shadow: 0 1px 5px rgba(0,0,0,0.4);
			background: #fff;
			border-radius: 5px;
			
			z-index:1000;
		}
		
		.touch .button {
			border:2px solid rgba(0, 0, 0, 0.2);
			box-shadow:none;
			width:44px;
			height:44px;
			line-height:44px;
		}
		
		
		#sidebar_button{
			top:56px;
		}
		.touch #sidebar_button {
			
			top:64px;
		}
		
		#tracking_button{
			top:102px;	
		}
		#tracking_button.enabled{
			color:#BB0000;
		}
		#tracking_button.enabled i{
			-webkit-animation: fade 1s linear infinite;
			-moz-animation: fade 1s linear infinite;
			-ms-animation: fade 1s linear infinite;
			-o-animation: fade 1s linear infinite;
			animation: fade 1s linear infinite;
		}
		.touch #tracking_button{
			top:118px;	
		}
		
		#tracking_info{
			disaplay:none;
			position:absolute;
			top:0px;
			right:60px;
			font-size:0.8em;
			background-color : rgba(255,255,255,0.8);
		}
		
		
		#number_filter{
			border:solid 1px #888;
			background-color: rgba(255,255,255,0.4);
		}
		.help{
			color:#444;
			font-style: italic;
			font-size:90%;
			padding:0.5em 2em 0.5em 2em;			
		}
		.centered{			
			text-align:center;			
		}
		.error {
			color:red;
			font-weight: bold;
			font-size:110%;
			padding:0.5em 2em 0.5em 2em;
		}
		#mission_detail_help{
			padding:3em;		
		}
		#mission_detail{
			padding:0.5em 1em ;
		}
		#stats li{
			list-style-type: none;
		}
		#stats ul{
			padding-left:15px;
		}
		#stat_detail{
			display:block;
			clear:right;
			text-align:center;
			font-size:0.8em;
		}
		#details{
			height:120px;
		}
		#about>div{
			padding:0.5em 1em;
			color:#333;
			font-size:0.9em;
		}
		
		#camembert {
		margin-top:20px;
			width:80px;
			height:120px;
			float:right;
			opacity:0.8;
		}
		
		.jqplot-grid-canvas{
			display:none;
		}

		.titleBlock{
			border-bottom: 1px solid #888888;
			display:block;
		}
		
		table#detailInfoMission {
			width:100%
		}
		table#detailInfoMission tr{
			border-bottom: 1px solid #888888;
		}
		table#detailInfoMission th{
			color:#339Fdd ;
		}
		
		.arret_green{ background-color:#ccffcc}
		.arret_yellow{ background-color:#ffffcc}
		.arret_orange{ background-color:#ffeecc}
		.arret_red{ background-color:#ffcccc}
		.arret_black{ background-color:#aaaaaa}
		.arret_depasse {
			color:grey;
			font-style: italic;
			text-decoration: line-through;
			background-color:#fff;
		}
		.arret_next {
			font-weight:bold;background-color:none;
		}

		
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="sidebar">
		<div id="title">
			<span id="icon">
				<img id="icon-loading" src="./static/images/train_loading.gif"/>
				<img id="icon-fixed" src="./static/images/train_full.png"/>
			</span>
			OSM Tchoutchou
		</div>
		<div id="stats"> </div>
		<div id="type_selection" class="block">
			<div class="titleBlock"><i class="fa fa-magic"></i>   <strong>Filtres :</strong></div>
			<br>
			  Train n°<input type="text" id="number_filter" class="filter"/>
			<br />
			<label><input type="checkbox" class="filter" name="simple" checked="checked"/>TER / Intercités</label>
			<label><input type="checkbox" class="filter" name="tgv" checked="checked"/>TGV</label>
			<label><input type="checkbox" class="filter" name="thalys" checked="checked"/>Thalys</label>
			<label><input type="checkbox" class="filter" name="unknown" checked="checked"/>Autres</label>
			<br />
			<label><input type="checkbox" class="filter" name="ok"/>À l'heure</label>
			<label><input type="checkbox" class="filter" name="delayed" checked="checked"/>En retard</label>
			<label><input type="checkbox" class="filter" name="cancelled" checked="checked"/>Supprimé</label>
		</div>
		<div></div>
		<div id="detail_block" class="block" >
			<div class="titleBlock"><i class="fa fa-search"></i>  <strong>Détail du train :</strong></div>
			<div id="details">
				<div id="mission_detail_help" class="help centered" >Survolez un train pour en voir les détails</div>
				<div id="mission_detail"></div>
			</div>
		</div>
		<div id="histo_block" class="block toggle closed">
			<div class="titleBlock fa"> <i class="fa fa-book"></i>  <strong>Historique :</strong></div>
			<div id="historique" class="blockContent">
				<div id="historique_help" class="help">
					Date à laquelle vous souhaitez voir l'état du traffic.
					<br> Le curseur règle le décalage entre chaque jeux de  données..
					<br><i class="fa fa-power-off" ></i> stoppe le mode historique et revient au présent
				</div>
				date : <input size="15" type="text" id="dateHistorique" class="datetimepicker" />
				<button id="btnStopHisto" type="button" title="Stoppe le mode historique"><i class="fa fa-power-off" ></i></button>				
				<br>		
				Prochaines données : <span id="txtMultiplicateurVitesseHistorique" ></span>
				<input type="hidden" id="multiplicateurVitesseHistorique" />
				
				<div id="sliderHistoTime"></div>
			</div>
		</div>
		<div id="about" class="block">
			<div class="titleBlock"><i class="fa fa-info-circle"></i> À propos</div>
			<div>
				Radar des trains, utilisant des cartes <a href="http://www.openstreetmap.org" target="_blank">Open Street Map</a>. 
				<br/>
				Données provenant du <a href="http://raildar.fr" target="_blank">raildar.fr</a> 
				de <a href="http://blog.spyou.org/wordpress-mu/2013/11/30/jstchoutchou/" target="_blank">@Turblog</a>. 
				<br/>
				Sources et détails sur <a href="https://github.com/bumblebeefr/osm-tchoutchou" target="_blank">github</a>.
			</div>
		</div> 
	</div>
	<div id="sidebar_button" class="button"><i class="fa fa-cogs"></i></div>
	<div id="tracking_button"  class="button"><i class="fa fa-location-arrow"></i></div>
	<div id="tracking_info"></div>
	<script src="./static/leaflet.js"></script>
	<script src="./static/leaflet-hash.js"></script>
	<script src="./static/jquery-2.0.3.js"></script>
	<script src="./static/jquery.jqplot.js"></script>
	<script src="./static/jqplot.pieRenderer.js"></script>
	<script src="./static/bootstrap3/js/bootstrap.min.js"></script>
	<script src="./static/bootstrap3/js/bootbox.js"></script>
	<script src="./static/moment.min.js"></script>
	<script src="./static/moment.fr.js"></script>
	<script src="./static/handlebars.js"></script>
	<script src="./static/handlebars-helpers.js"></script>
	<script src="./static/handlebars-util.js"></script>
	<script src="./static/raildar/library.js"></script>
	<script src="./static/raildar/Train.js"></script>
	<script src="./static/raildar/Tracking.js"></script>
	<!-- date time picker-->
	<script src="./static/jquery-ui-1.10.3.custom.min.js"></script>
	<script src="./static/jquery-ui-timepicker-addon.js"></script>
	
	<!-- fin date time picker-->
	

	<script>
		//variable permettant d'agir dans la page sur certains traitements
		//refreshMissions relance eriodiquement le traitement des missions (refresh data+carte)
		var DEBUG ={refreshMissions:true,nocontrols:false};
		if(document.location.search.indexOf("nocontrols") > -1){
			DEBUG.nocontrols = true;
		}
		
		var getDateHistorique = function (){
			strDate=$("#dateHistorique").val();
			var dateH=moment(strDate, "DD-MM-YYYY HH:mm:ss");
			return (dateH && dateH>0 && dateH.diff(moment())<0 )?dateH:null;
		};
		var traiteDelaiHisto = function (){
			var mult=parseInt($("#multiplicateurVitesseHistorique").val());
			var oldTime=parseInt(getDateHistorique().unix());
			var newTimestamp=60*mult+oldTime; 
			var newMoment=moment(newTimestamp*1000)
			console.log("futur timestamp : " + newTimestamp + " = "+ newMoment.format("LLLL"));
			$("#dateHistorique").val(newMoment.format("DD/MM/YYYY HH:mm:ss"));
		};
		var get = function(obj,key,default_value){
			if( key in obj) return obj[key];
			else return default_value;
		};
		
		//Webwoker tha wil get and filter circulation/trains
		var callbacks = {
				circulation_error : function(data){
					if(console && console.error){
						console.error("Error when loading #jstchouchou data ",data.textStatus);
					}
					bootbox.alert("Erreur de récupération des données de la mission ("+data.textStatus+")", function() {});
				},
				circulation_success : function(data){
					Missions.statuses = {ttl:0};
					Missions.statuses['indicateur_histo'] =  (Missions.modeHistorique.isOn)?"<i class='fa fa-book'></i>":"";
					var mission_ids ={};
					Missions.statuses['hour'] = null;
					$.each(data.missions,function(){
							try{
								var mission = Missions.add(this);
								mission_ids[mission.id_mission] = true;
								if(!(mission.status in Missions.statuses)){
									//console.info("Nouveau type : ",mission.type);
									Missions.statuses[mission.status] = 1;
								}else{
									Missions.statuses[mission.status]  += 1;
								}
								if(!(mission.type in Missions.statuses)){
									//console.info("Nouveau type : ",mission.type);
									Missions.statuses[mission.type] = 1;
								}else{
									Missions.statuses[mission.type]  += 1;
								}
								Missions.statuses['ttl']  += 1;
								if(Missions.statuses['hour'] == null){
									if( Missions.modeHistorique.isOn){
										Missions.statuses['hour'] =  getDateHistorique().format("LLLL");
										traiteDelaiHisto();
									} else {
										Missions.modeHistorique.isOn=false;
										Missions.statuses['hour'] = "Aujourd'hui à "+moment(mission.last_update).format("HH:mm:ss");
									}
								}
							} catch(e){
								console.error("Oups ya un probleme avec le point là ",this,e);
							}
					});

					// ici on ne doit jamais être rentré dans la boucle (aucune feature ramenée) car Missions.statuses['hour'] ==null
					// dans ce cas il faut quand même, en cas d'histo, calculer la date histo suivante sinon on bloque au meme moment
					if(Missions.statuses['hour'] == null && Missions.modeHistorique.isOn && getDateHistorique() ){
						Missions.statuses['hour']=getDateHistorique().format("LLLL") +" Aucune donnée disponible";
						traiteDelaiHisto();
					} 
					
					//netoyage des mission terminées
					Missions.clean(mission_ids);
					delete(mission_ids);
					
					//Affichage des stats
					$("#stats").html(HandlebarsUtil.render('stats',Missions.statuses));
					
					var pcts = {
							"green" : 0,
							"yellow" : 0,
							"orange" :0,
							"red":0,
							"black":0
					}
					for(k in pcts){
						if(k in Missions.statuses){
							pcts[k] = Math.round(Missions.statuses[k]/Missions.statuses.ttl*1000)/10;
						}
					}
					var data = [
					   ['green',pcts.green], ['yellow',pcts.yellow], ['orange',pcts.orange], ['red',pcts.red], ['black',pcts.black]
					  ];
					  var plot1 = jQuery.jqplot ('camembert', [data],
					    {
						  seriesColors:['#35a619','#b7c916','#c79516','#c71818','#575757'],
					      seriesDefaults: {
					    	fillAlpha :0,
					        // Make this a pie chart.
					        renderer: jQuery.jqplot.PieRenderer,
					        rendererOptions: {
						        padding:3,
						        shadowOffset:0.9,
					             startAngle: -90
					        }
					      }
					    });
					  delete(pcts);
					  delete(data);
					  delete(plot1);
			
					$("#icon").removeClass("loading");
					console.timeEnd("load");
				},
				// apres traitement succes ou erreur
				circulation_complete : function(jqXHR, textStatus){
					if (DEBUG.refreshMissions) {
						var delai=Missions.refreshDelays.live	//par defaut on rafraichit le live		
						if(getDateHistorique()) {
							Missions.modeHistorique.isOn=true;
							delai=Missions.refreshDelays.histo //en cas d'historique, on va plus vite
						} else {
							Missions.modeHistorique.isOn=false;
						} 
						setTimeout(Missions.show,delai);
					}
				}
			};
		var trainWorker = new Worker('./static/raildar/TrainWorker.js');
		trainWorker.addEventListener("message", function (event) {
			callbacks[event.data.type](event.data.data);
		});
		
		
		var Missions = {
			// en millisecondes (pour settimeout())
			refreshDelays:{
				live:10000,
				histo:2000
			},
			modeHistorique:{
				isOn:false
			},
			icons:{
				green: L.divIcon({className: 'circle-icon circle-icon-green',iconSize:L.point(22,22), html:'<img src="./static/images/fleche_green.png" />'}),
				yellow: L.divIcon({className: 'circle-icon circle-icon-yellow',iconSize:L.point(22,22), html:'<img src="./static/images/fleche_yellow.png" />'}),
				orange: L.divIcon({className: 'circle-icon circle-icon-orange',iconSize:L.point(22,22), html:'<img src="./static/images/fleche_orange.png" />'}),
				red: L.divIcon({className: 'circle-icon circle-icon-red',iconSize:L.point(22,22), html:'<img src="./static/images/fleche_red.png" />'}),
				black: L.divIcon({className: 'circle-icon circle-icon-black',iconSize:L.point(22,22), html:'<img src="./static/images/fleche_black.png" />'})
			},
			markers:{},
			missions:{},
			statuses:{ttl:0},
			add : function(mission){
				Missions.missions[mission.id_mission] = mission;
				Train.drawMarker(mission,true);
				return mission;
			},
			//redraw each mission whithout changing data (after an UI event for example)
			redrawMarkers : function(){
				$("#icon").addClass("loading");
				console.time("redraw");
				$.each(Missions.missions,function(){
					Train.drawMarker(this);
				});
				console.timeEnd("redraw")
				$("#icon").removeClass("loading");
				
				/* if(Missions.markers.length >10){
					$("body").removeClass("animated");
				}else{
					$("body").addClass("animated");
				} */
			},
			traiteHisto:function(){
				
			},
			show : function(){
				$("#icon").addClass("loading");
				var params={};
				var dateHisto=getDateHistorique();
				if (Missions.modeHistorique.isOn || dateHisto){
				  console.info("Mode historique demandé : timestamp = "+dateHisto.format("X")+" date = "+dateHisto.format("LLLL"));
				  params["date"]=dateHisto.format("X");
				}
				if(Tracking.running == 2 && Tracking.id_mission !=null){
					params['id_mission'] = Tracking.id_mission;
				}
				
				//Call the web worker that will load and filter data.
				//See trainWorker configuration for callbacks
				trainWorker.postMessage(new WorkerMessage('get_circulation', { data : params}));

			},
			clean : function(mission_ids){
				for(k in Missions.missions){
					if( mission_ids && !(k in mission_ids)){
						Train.removeMarker(Missions.missions[k]);
						delete(Missions.missions[k]);
						//console.info('Remove mission from map '+k);
					}else{
						if(!Train.isVisible(Missions.missions[k])){
							Train.removeMarker(Missions.missions[k]);
						};
					}
				}
				/* if(Missions.markers.length >10){
					$("body").removeClass("animated");
				}else{
					$("body").addClass("animated");
				} */
			}
		};

		var cloudmadeLayer = L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
			maxZoom: 18,
			minZoom: 6,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
		});

		var transportLayer = L.tileLayer('http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png', {
			maxZoom: 18,
			minZoom: 6,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://www.thunderforest.com/">Thunderforest</a>'
		});

		var mapquestLayer = L.tileLayer('http://otile2.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
			maxZoom: 18,
			minZoom: 6,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://www.mapquest.com/">Mapquest</a>'
		});
		
		var osmLegacyLayer = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 18,
			minZoom: 6,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://www.openstreetmap.org/">OpenStreetMap</a>'
		});
		

		var map = L.map('map',{
			center: new L.LatLng(46.354510837365254,3.33984375),
			zoom:6,
			layers: [mapquestLayer],
			attributionControl: false,
			zoomControl: false
		});

		var baseMaps = {
			    "Mapquest": mapquestLayer,
			    "CloudMade": cloudmadeLayer,
			    "Transport": transportLayer,
			    "OSM Legacy": osmLegacyLayer
		};
		var overlayMaps = {};
		if(!DEBUG.nocontrols){
			L.control.layers(baseMaps, overlayMaps).addTo(map);
			L.control.scale({imperial:false}).addTo(map);
			L.control.attribution().addTo(map);
			L.control.zoom().addTo(map);
		}else{
			$(".button").hide();
		}
		map.on('zoomend',Missions.redrawMarkers).on('dragend',Missions.redrawMarkers);
		
		 var hash = new L.Hash(map);
		 
		//Sart leaflet geolocation.
		Tracking.init();

		Missions.show();


		function onResize(){
			$("#sidebar").height($(window).height());
		}
		
		function infoLigne(idMission){
			//id=idMission.substr("mission".length)
			jQuery.ajax("http://www.raildar.fr/json/convert?url=get_mission",{
					async : true,
					cache : false,
					data : {"id_mission":idMission},	
					error : function(jqXHR,textStatus,errorThrown){
							if(console && console.error){
								console.error("Error when loading #jstchouchou data ",jqXHR);
							}
							bootbox.alert("Erreur de récupération des données de la mission ("+jqXHR.status+")", function() {});
					},
					success : function(data, textStatus, jqXHR){
						var mission=Missions.missions[idMission];
						data["txtInfoTrain"]=mission.brand+" - "+mission.num ;
						var nextGareAtteinte=false;
						
						
						$.each(data.arrets.arret,function(index,arret){
							//determine ou on en est dans le circuit
							arret["arret_depasse"]=true;
							if (! nextGareAtteinte && arret.id_gare== mission.id_next_gare){
								nextGareAtteinte=true;
								arret["is_next_gare"]=true;
								arret["human_time_to_gare"]="(dans "+mission.human_time_to_next_gare+")";								;
								arret["arret_depasse"]=false;
								arret["minutes_to_gare"]=mission.minutes_to_next_gare
							}
							if (nextGareAtteinte){
								arret["arret_depasse"]=false;
							}
							
														
							if (arret.minutes_retard<0){
								arret["classe_retard"]="arret_black";
							} else if (arret.minutes_retard<5){
								arret["classe_retard"]="arret_green"
							} else if (arret.minutes_retard<15){
								arret["classe_retard"]="arret_yellow"
							} else if (arret.minutes_retard<30){
								arret["classe_retard"]="arret_orange"
							} else {
								arret["classe_retard"]="arret_red"
							}
						});
						
						bootbox.alert(HandlebarsUtil.render('mission',data), function() {
						})
					}
			});
			
		}

		// #####################################################################################
		// #####################################################################################
		$(function(){
			onResize();
			$(window).resize(onResize);
			
			$( ".datetimepicker" ).datetimepicker({minDate: moment("2013-11-25 05:00:00").toDate(), maxDate: "+0D"});

			$( "#sliderHistoTime" ).slider({
					range: "min",
					value: 1,
					min: 1,
					max: 1440,
					slide: function( event, ui ) {
						$( "#multiplicateurVitesseHistorique" ).val( ui.value );
						var txt=moment.duration(ui.value, 'minutes').humanize();						
						$( "#txtMultiplicateurVitesseHistorique" ).html( txt );
					}
			});
			$( "#multiplicateurVitesseHistorique" ).val($( "#sliderHistoTime" ).slider( "value" ) );
			$( "#txtMultiplicateurVitesseHistorique" ).html(moment.duration( $( "#sliderHistoTime" ).slider( "value" ), 'minutes').humanize() );

			$("#btnStopHisto").click(function(event) {
				Missions.modeHistorique.isOn=false;
				$("#dateHistorique").val("");
			});
		
			function traiteToggleBlock(elt){
				if ($(elt).parent().hasClass("closed")){
					$(elt).next().slideUp();
					$(elt).addClass("fa-plus-square").removeClass(" fa-minus-square");	
				} else {
					$(elt).next().slideDown();
					$(elt).addClass("fa-minus-square").removeClass(" fa-plus-square");				
				}
			}
			$(".block.toggle .titleBlock").each(function(index){traiteToggleBlock($(this))})			
			$(".block.toggle .titleBlock").click(function(event){
				$(this).parent().toggleClass("closed");
				traiteToggleBlock($(this));
				
			});

			if(L.Browser.touch){
				$("body").addClass("touch");	
				$("#detail_block").hide();
			}else{
				$("#sidebar").show();
			}
			$("input.filter").change(function(){
				Missions.redrawMarkers();
			});

 			$("#sidebar_button" ).click(function(){
 				$("#sidebar").toggle();
 			});
 			
 			$("#tracking_button").click(function(){
 				$("#sidebar").hide();
 				if(Tracking.started){
 					if(confirm('Arreter le tracking en cours ?')){
 	 					Tracking.stop();
 					}
	 			}else{
	 				Tracking.start();
	 			}
 			}).tooltip({
 				placement : 'left',
 				title : function(){
 					if($(this).hasClass('enabled')){
 						return "Stopper le tracking en cours";
 					}else{
 						return "Demarrer l'enregistrement et le tracking d'un train";
 					}
 				}
 			});
 			$("body").on('click','#stat_detail',function(e){
 				e.preventDefault();
 				var html = $("<div/>").html("<a href='"+$(this).attr('href')+"' target='rrd'><img src='"+$(this).attr('href')+"' style='max-width:100%'/></a>");
 				bootbox.dialog({
 					title : "Historique de circulation :",
 					message: html
 				});
 			});
 			
 			
 			
		});
		
		

			
	</script>
</body>
</html>